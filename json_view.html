<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON View</title>
    <style>
        textarea {
            width: 100%;
            height: 100px;
        }
        #output {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>JSON View</h1>
    <textarea id="jsonInput" placeholder="Enter JSON here..."></textarea>
    <button onclick="formatJSON()">Format JSON</button>
    <div id="output"></div>

    <script>
	function generateCombinations(n, m) {
	    const result = [];
	    const combination = [];
	
	    function backtrack(nRemaining, mRemaining) {
	        if (nRemaining === 0 && mRemaining === 0) {
	            result.push(combination.join(''));
	            return;
	        }
	
	        if (nRemaining > 0) {
	            combination.push(']');
	            backtrack(nRemaining - 1, mRemaining);
	            combination.pop();
	        }
	
	        if (mRemaining > 0) {
	            combination.push('}');
	            backtrack(nRemaining, mRemaining - 1);
	            combination.pop();
	        }
	    }
	
	    backtrack(n, m);
	    return result;
	}
   
        function fix_and_return_json(data) {
            data = data.replace(/,\s*([\]}])/g, '$1');
            try { return JSON.parse(data); } catch (e) {}

            if (data.includes("'")) {
                if (!data.includes('"')) {
                    data = data.replace(/'/g, '"');
                    try { return JSON.parse(data); } catch (e) {}
                } else if (data.includes('\\"')) {
                    data = data.replace(/\\"/g, 'XXXXX');
                    if (!data.includes('"')) {
                        data = data.replace(/'/g, '"');
                        data = data.replace(/XXXXX/g, "'");
                        try { return JSON.parse(data); } catch (e) {}
		    } else {
		        data = data.replace(/XXXXX/g, '\\"');
		    }
                }
            }
            data = data.replace(/\b(True|False|TRUE|FALSE|NULL|Null)\b/g, function(match) {return match.toLowerCase();});
            try { return JSON.parse(data); } catch (e) {}
        
            // Count and attempt to balance brackets and quotes
            const openBrackets = (data.match(/\[/g) || []).length;
            const closeBrackets = (data.match(/\]/g) || []).length;
            const openBraces = (data.match(/{/g) || []).length;
            const closeBraces = (data.match(/}/g) || []).length;
            const quotes = (data.match(/(?<!\\)"/g) || []).length; // Ignore escaped quotes
        
        
            // Balance double quotes
            if (quotes % 2 !== 0) {
                data += '"';
            }
            try { return JSON.parse(data); } catch (e) {}
        
            // Balance brackets and braces
            if (openBraces == closeBraces && openBrackets > closeBrackets) {
                data += ']'.repeat(openBrackets - closeBrackets);
                try { return JSON.parse(data); } catch (e) {}
                data = data.replace(/,\s*([\]}])/g, '$1'); try { return JSON.parse(data); } catch (e) {}
            }   
            if (openBrackets == closeBrackets && openBraces > closeBraces) {
                var data1 = data + '}'.repeat(openBraces - closeBraces);
                var data2 = data + ':"add_to_fix_json"' + '}'.repeat(openBraces - closeBraces);
                var data3 = data + '"add_to_fix_json"' + '}'.repeat(openBraces - closeBraces);

                try { return JSON.parse(data1); } catch (e) {}
                data = data1.replace(/,\s*([\]}])/g, '$1'); try { return JSON.parse(data); } catch (e) {}

                try { return JSON.parse(data2); } catch (e) {}
                data = data2.replace(/,\s*([\]}])/g, '$1'); try { return JSON.parse(data); } catch (e) {}

                try { return JSON.parse(data3); } catch (e) {}
                data = data3.replace(/,\s*([\]}])/g, '$1'); try { return JSON.parse(data); } catch (e) {}
            }
            if (openBrackets > closeBrackets && openBraces > closeBraces) {
                const match = data.match(/\S/);
                var start_letter = match ? match[0] : null;
                const combinations = generateCombinations(openBrackets - closeBrackets, openBraces - closeBraces);
                for (var idx in combinations) {
                    var comb = combinations[idx];
                    const lastChar = data.charAt(data.length - 1); 
                    if (start_letter == '[' && lastChar != ']') continue;
                    if (start_letter == '{' && lastChar != '}') continue;

                    var data1 = data + comb;
                    try { return JSON.parse(data1); } catch (e) {}
                    data = data1.replace(/,\s*([\]}])/g, '$1'); try { return JSON.parse(data); } catch (e) {}

                    if (comb[0] == '}') {
                        var data2 = data + ':"add_to_fix_json"' + comb;
                        var data3 = data + '"add_to_fix_json"' + comb;


                        try { return JSON.parse(data2); } catch (e) {}
                        data = data2.replace(/,\s*([\]}])/g, '$1'); try { return JSON.parse(data); } catch (e) {}

                        try { return JSON.parse(data3); } catch (e) {}
                        data = data3.replace(/,\s*([\]}])/g, '$1'); try { return JSON.parse(data); } catch (e) {}
                    }   
                }   
            }   
            return null
          
        }
        function formatJSON() {
            const input = document.getElementById('jsonInput').value;
            const singleLineInput = input.replace(/\n/g, '').replace(/\t/g, '        '); // 拼接成单行
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = ''; // Clear previous output
           //console.log(singleLineInput)

            try {
                const jsonObj = JSON.parse(singleLineInput);
                const formattedHTML = formatValue(jsonObj);
                outputDiv.appendChild(formattedHTML);
            } catch (e) {
		const jsonObj = fix_and_return_json(singleLineInput);
		if (jsonObj === null) {
                	outputDiv.textContent = 'Invalid JSON input.';
			return
		}
                const formattedHTML = formatValue(jsonObj);
                outputDiv.appendChild(formattedHTML);
            }
        }

        function formatValue(value) {
            if (Array.isArray(value)) {
                return formatArray(value);
            } else if (typeof value === 'object' && value !== null) {
                return formatDict(value);
            } else if (typeof value === 'string') {
                return formatString(value);
            } else {
                return document.createTextNode(String(value));
            }
        }

        function formatDict(dict) {
            const table = document.createElement('table');
            for (const [key, val] of Object.entries(dict)) {
                const row = table.insertRow();
                const keyCell = row.insertCell();
                keyCell.textContent = key;
                keyCell.style.backgroundColor = 'lightgreen';

                const valueCell = row.insertCell();
                valueCell.appendChild(formatValue(val));
            }
            return table;
        }

        function doesNotStartWithBraceOrBracket(str) {
                if (typeof str !== 'string' || str.length === 0) {
                        return false; // 如果不是字符串或为空字符串，返回 false
                }
                const firstChar = str.charAt(0); // 或者使用 str[0]
                return firstChar !== '{' && firstChar !== '[';
        }

        function formatArray(arr) {
            if (arr.every(item => typeof item === 'number' || typeof item === 'boolean')) {
                return document.createTextNode(arr.join(' | '));
            } else if (arr.every(item => typeof item === 'string' && item.length < 50 && doesNotStartWithBraceOrBracket(item))) {
                return document.createTextNode(arr.join(' | '));
            } else if (arr.every(item => typeof item === 'string' && item.length > 50 && doesNotStartWithBraceOrBracket(item))) {
                const ul = document.createElement('ol');
                arr.forEach(item => {
                    const li = document.createElement('li');
                    li.appendChild(formatString(item));
                    ul.appendChild(li);
                });
                return ul;
            } else {
                const ul = document.createElement('ol');
                arr.forEach(item => {
                    const li = document.createElement('li');
                    li.appendChild(formatValue(item));
                    ul.appendChild(li);
                });
                return ul;
            }
        }

        function formatString(str) {
            try {
                const parsedStr = JSON.parse(str);
                return formatValue(parsedStr);
            } catch {
                // console.log('xxx', str,str.includes('\\n' ));
                //if (str.includes('\\n') || str.includes('\\t')) {
                //str = str.replace("<", "&lt;");
                //str = str.replace(">", "&gt;");
                if (str.includes('\n')) {
                    const pre = document.createElement('pre');
                    // pre.textContent = str.replace(/\\n/g, '\n').replace(/\\t/g, '\t');
                    pre.textContent = str;
                    return pre;
                } else {
                    return document.createTextNode(str);
                }
            }
        }
    </script>
</body>
</html>
